// Metagenome Assembly and Diamond Taxonomic Classification Workflow Configuration (English Version)
//
// This configuration is used for:
// 1. Metagenome assembly (MEGAHIT and SPAdes) - contigs are automatically saved
// 2. Gene prediction (Prodigal)
// 3. Diamond classification with RVDB database (requires --diamond_db parameter)
// 4. Taxonomy resolution (NCBI taxonomy database)
//
// Database: RVDB (Reference Viral DataBase) - optimized for viral metagenomics
// Resource allocation is optimized for RVDB (smaller database than NCBI nr)
//
// Usage examples:
// Short reads: nextflow run workflow_en.nf -c metagenome_assembly_classification_en.config --input samplesheet_short.csv --outdir results --diamond_db /path/to/RVDB/RVDB_prot_ref.dmnd --read_type short
// Long reads:  nextflow run workflow_en.nf -c metagenome_assembly_classification_en.config --input samplesheet_long.csv --outdir results --diamond_db /path/to/RVDB/RVDB_prot_ref.dmnd --read_type long

process {
    executor = 'slurm'
    // 重要：Nextflow 的各个 process 任务提交到哪个分区，取决于这里的 queue（而不是 sbatch 脚本的 partition）
    // 你已在 sbatch 脚本中使用 highmem_p，这里也同步到 highmem_p，避免 MEGAHIT 等任务跑到非高内存分区
    queue = 'highmem_p'
    // 确保子任务继承提交环境变量（尤其是 PATH/CONDA_*），否则 Nextflow 的 conda wrapper 可能找不到 conda
    clusterOptions = '--ntasks=1 --export=ALL'
    
    errorStrategy = 'retry'
    maxRetries = 2
    
    // 关键：Nextflow 的 conda 机制是在“计算节点任务”里执行的
    // 如果任务环境里没有 conda，会出现：
    //   conda: command not found
    //   /bin/activate: No such file or directory
    // 这里让每个 SLURM 任务自动加载 Miniforge3 模块，确保 conda 命令可用
    module = 'Miniforge3/24.11.3-0'
    
    // 关键：Nextflow 的 conda 功能（FASTP/PRODIGAL/DIAMOND 等进程使用 conda 指令）
    // 需要在“计算节点任务环境/任务 wrapper”里能找到 conda 命令，否则会报：
    //   conda: command not found
    // 这里用 Nextflow config 的标准写法注入 PATH（在生成的任务脚本中生效）
    // 注意：包含 condabin 是为了兼容 conda 的初始化脚本布局
    env.PATH = "/scratch/sp96859/conda/bin:/scratch/sp96859/conda/condabin:${System.getenv('PATH')}"
    
    // Default resource allocation
    cpus = 16
    memory = '64 GB'
    time = '36h'
    
    // Process-specific resource allocation
    withName: 'FASTP' {
        cpus = 16
        memory = '64 GB'
        time = '36h'
        label = 'process_medium'
    }
    
    withName: 'MEGAHIT_ASSEMBLY' {
        cpus = 16
        // MEGAHIT 对超大数据集非常吃内存，64GB 很容易被 OOM SIGKILL（你日志里 megahit_core Exit code -9）
        // 这里提高到 256GB（megahit --memory 会按 params.megahit_memory 比例使用）
        memory = '256 GB'
        time = '36h'
        label = 'process_high'
        // 使用你单独创建的 megahit_env 运行 megahit（不在 nextflow_env 里安装）
        // 说明：这里直接把 megahit_env/bin 注入到任务 PATH，避免在任务里做 conda activate
        beforeScript = 'export PATH=/home/sp96859/.conda/envs/megahit_env/bin:$PATH'
    }
    
    withName: 'SPADES_ASSEMBLY' {
        // 重要：一些 highmem 节点物理内存约 459G（系统保留后可用更少），即使申请 512G 也可能被 SPAdes 误判/超配导致 OOM
        // 这里把默认资源设得更保守，优先保证能稳定跑完；如确实有 512G+ 节点可用，可再上调
        cpus = 16
        memory = '448 GB'
        time = '96h'       // Metagenome assembly requires longer time
        label = 'process_high'
        // 使用你单独创建的 spades_env 运行 SPAdes（不在 nextflow_env 里安装）
        // 说明：这里直接把 spades_env/bin 注入到任务 PATH，避免在任务里做 conda activate
        beforeScript = 'export PATH=/home/sp96859/.conda/envs/spades_env/bin:$PATH'
    }
    
    withName: 'PRODIGAL_MEGAHIT' {
        cpus = 16
        memory = '64 GB'
        time = '36h'
        label = 'process_medium'
    }
    
    withName: 'PRODIGAL_SPADES' {
        cpus = 16
        memory = '64 GB'
        time = '36h'
        label = 'process_medium'
    }
    
    withName: 'DIAMOND_CLASSIFICATION_MEGAHIT' {
        cpus = 16
        memory = '64 GB'  // Reduced for RVDB (smaller database)
        time = '36h'      // Faster with RVDB
        label = 'process_high'
    }
    
    withName: 'DIAMOND_CLASSIFICATION_SPADES' {
        cpus = 16
        memory = '64 GB'  // Reduced for RVDB (smaller database)
        time = '36h'      // Faster with RVDB
        label = 'process_high'
    }
    
    withName: 'MERGE_DIAMOND_REPORTS' {
        cpus = 16
        memory = '64 GB'
        time = '36h'
        label = 'process_low'
    }

    // Short read abundance calculation processes
    // 这里使用 Nextflow conda 自动创建环境，确保 bwa/samtools/python/pandas 在计算节点可用
    withName: 'CALCULATE_ABUNDANCE_MEGAHIT_SHORT' {
        cpus = 16
        memory = '64 GB'
        time = '36h'
        label = 'process_medium'
        conda = 'conda-forge::python conda-forge::pandas bioconda::bwa bioconda::samtools'
    }
    
    withName: 'CALCULATE_ABUNDANCE_SPADES_SHORT' {
        cpus = 16
        memory = '64 GB'
        time = '36h'
        label = 'process_medium'
        conda = 'conda-forge::python conda-forge::pandas bioconda::bwa bioconda::samtools'
    }
    
    withName: 'CALCULATE_ABUNDANCE_METAFLYE' {
        cpus = 16
        memory = '28 GB'
        time = '36h'
        label = 'process_medium'
    }
    
    withName: 'CALCULATE_ABUNDANCE_VIRALFLYE' {
        cpus = 16
        memory = '64 GB'
        time = '36h'
        label = 'process_medium'
    }
    
    // Long read process resource allocation
    withName: 'METAFLYE_ASSEMBLY' {
        cpus = 32
        memory = '128 GB'  // MetaFlye requires more memory
        time = '6h'       // Long-read assembly requires more time
        label = 'process_high'
    }
    
    withName: 'VIRALFLYE_REFINEMENT' {
        cpus = 16
        memory = '128 GB'
        time = '48h'
        label = 'process_medium'
    }
    
    // Long read process resource allocation
    withName: 'PRODIGAL_METAFLYE' {
        cpus = 16
        memory = '64 GB'
        time = '64h'
        label = 'process_medium'
    }
    
    withName: 'PRODIGAL_VIRALFLYE' {
        cpus = 16
        memory = '64 GB'
        time = '48h'
        label = 'process_medium'
    }
    
    withName: 'DIAMOND_CLASSIFICATION_METAFLYE' {
        cpus = 16
        memory = '64 GB'
        time = '48h'
        label = 'process_high'
    }
    
    withName: 'DIAMOND_CLASSIFICATION_VIRALFLYE' {
        cpus = 16
        memory = '128 GB'
        time = '48h'
        label = 'process_high'
    }
    
    withName: 'ADD_TAXONOMY_METAFLYE' {
        cpus = 16
        memory = '64 GB'
        time = '36h'
        label = 'process_low'
    }
    
    withName: 'ADD_TAXONOMY_VIRALFLYE' {
        cpus = 16
        memory = '64 GB'
        time = '48h'
        label = 'process_low'
    }
    
    withName: 'COMPARE_DUAL_TRACKS' {
        cpus = 16
        memory = '64 GB'
        time = '36h'
        label = 'process_low'
    }
}

params {
    // Output directories (automatically created)
    // - assembly_megahit/: MEGAHIT assembled contigs
    // - assembly_spades/: SPAdes assembled contigs
    // - prodigal_megahit/: Gene predictions from MEGAHIT
    // - prodigal_spades/: Gene predictions from SPAdes
    // - diamond_megahit/: Diamond results for MEGAHIT
    // - diamond_spades/: Diamond results for SPAdes
    // - merged_reports/: Comprehensive analysis with taxonomy
    // - assembly_metaflye/: MetaFlye assembled contigs (long reads)
    // - assembly_viralflye/: viralFlye refined contigs (long reads, optional)
    // - prodigal_long/: Gene predictions from long reads
    // - diamond_long/: Diamond results for long reads
    
    // Resource  limits
    max_cpus = 32
    // 重要：全局最大内存上限建议与实际可用节点内存匹配，避免任务拿到的配额高于节点可用导致不可预期问题
    max_memory = '448.GB'
    max_time = '72.h'
    
    // Read type parameter
    read_type = 'short'  // 'short' for short reads (paired-end), 'long' for long reads (Nanopore/PacBio)
    
    // fastp quality control parameters (for short reads only)
    skip_fastp = false
    fastp_qualified_quality = 20    // Minimum quality value
    fastp_unqualified_percent = 40  // Maximum percentage of low-quality bases allowed
    fastp_min_length = 50           // Minimum read length
    
    // MEGAHIT assembly parameters (for short reads only)
    megahit_memory = 0.8
    megahit_min_contig_len = 1000
    
    // SPAdes parameters (for short reads only, using metaSPAdes mode)
    spades_meta = true
    
    // MetaFlye parameters (for long reads only)
    metaflye_genome_size = null     // Genome size estimate, e.g., '5m' or '10m', null means let Flye estimate automatically
    skip_viralflye = false          // Must enable viralFlye for viral data analysis
    
    // viralFlye parameters (requires Pfam-A HMM database)
    pfam_hmm = '/scratch/sp96859/Meta-genome-data-analysis/Apptainer/databases/Pfam/Pfam-A.hmm'  // Pfam-A HMM database path
    viralflye_min_length = 5000       // Minimum viral sequence length
    viralflye_completeness = 0.5      // Completeness threshold
    
    // Diamond parameters
    diamond_evalue = 1e-5
    diamond_max_target_seqs = 1
    diamond_outfmt = '6 qseqid sseqid pident length mismatch gapopen qstart qend sstart send evalue bitscore staxids'
    
    // Taxonomy database parameters (NCBI taxonomy for lineage resolution)
    taxonomy_names = '/scratch/sp96859/Meta-genome-data-analysis/Apptainer/databases/RVDB/names.dmp'
    taxonomy_nodes = '/scratch/sp96859/Meta-genome-data-analysis/Apptainer/databases/RVDB/nodes.dmp'
    
    // Merge reports parameters (for short reads only)
    skip_merge_reports = false  // Whether to skip comprehensive report generation
    
    // Abundance calculation parameters (for short reads only)
    skip_abundance = false  // Whether to skip viral abundance calculation (RPM and RPKM)
}

// Apptainer/Singularity configuration (no longer needed; MEGAHIT and SPAdes now use system environment nextflow_env)
// apptainer {
//     enabled = true
//     autoMounts = true
//     cacheDir = '/scratch/sp96859/Meta-genome-data-analysis/Apptainer/singularity'
// }

// Conda configuration (for Diamond, Prodigal, and fastp)
conda {
    enabled = true
    cacheDir = '/scratch/sp96859/Meta-genome-data-analysis/conda_cache'
}

// Environment variables (no container binding needed; MEGAHIT and SPAdes use system environment nextflow_env)
// nextflow_env path: /scratch/sp96859/conda/envs/nextflow_env
// Note: MEGAHIT and SPAdes processes rely on nextflow_env being activated in the run script
// env {
//     SINGULARITY_BIND = "/scratch/sp96859/Meta-genome-data-analysis/Apptainer/databases:/databases,/tmp:/lscratch"
// }

// Input samplesheet format
// For short reads (paired-end Illumina):
//   sample,fastq_1,fastq_2
//   llnl_66ce4dde,/path/to/sample_R1.fastq.gz,/path/to/sample_R2.fastq.gz
//
// For long reads (Nanopore/PacBio):
//   sample,fastq_long
//   llnl_66d1047e,/path/to/sample.fastq.gz

