// Metagenome Assembly and Diamond Taxonomic Classification Workflow Configuration (English Version)
//
// This configuration is used for:
// 1. Metagenome assembly (MEGAHIT and SPAdes) - contigs are automatically saved
// 2. Gene prediction (Prodigal)
// 3. Diamond classification with RVDB database (requires --diamond_db parameter)
// 4. Taxonomy resolution (NCBI taxonomy database)
//
// Database: RVDB (Reference Viral DataBase) - optimized for viral metagenomics
// Resource allocation is optimized for RVDB (smaller database than NCBI nr)
//
// Usage examples:
// Short reads: nextflow run workflow_en.nf -c metagenome_assembly_classification_en.config --input samplesheet_short.csv --outdir results --diamond_db /path/to/RVDB/RVDB_prot_ref.dmnd --read_type short
// Long reads:  nextflow run workflow_en.nf -c metagenome_assembly_classification_en.config --input samplesheet_long.csv --outdir results --diamond_db /path/to/RVDB/RVDB_prot_ref.dmnd --read_type long

process {
    executor = 'slurm'
    queue = 'bahl_p'
    clusterOptions = '--ntasks=1'
    
    errorStrategy = 'retry'
    maxRetries = 2
    
    // Default resource allocation
    cpus = 8
    memory = '32 GB'
    time = '6h'
    
    // Process-specific resource allocation
    withName: 'FASTP' {
        cpus = 8
        memory = '16 GB'
        time = '4h'
        label = 'process_medium'
    }
    
    withName: 'MEGAHIT_ASSEMBLY' {
        cpus = 16
        memory = '64 GB'
        time = '12h'
        label = 'process_high'
        // Uses system environment (nextflow_env); MEGAHIT must be pre-installed in nextflow_env
    }
    
    withName: 'SPADES_ASSEMBLY' {
        cpus = 32
        memory = '512 GB'  // Use large memory to avoid issues
        time = '48h'       // Metagenome assembly requires longer time
        label = 'process_high'
        // Uses system environment (nextflow_env); SPAdes must be pre-installed in nextflow_env
    }
    
    withName: 'PRODIGAL_MEGAHIT' {
        cpus = 4
        memory = '16 GB'
        time = '4h'
        label = 'process_medium'
    }
    
    withName: 'PRODIGAL_SPADES' {
        cpus = 4
        memory = '16 GB'
        time = '4h'
        label = 'process_medium'
    }
    
    withName: 'DIAMOND_CLASSIFICATION_MEGAHIT' {
        cpus = 16
        memory = '64 GB'  // Reduced for RVDB (smaller database)
        time = '12h'      // Faster with RVDB
        label = 'process_high'
    }
    
    withName: 'DIAMOND_CLASSIFICATION_SPADES' {
        cpus = 16
        memory = '64 GB'  // Reduced for RVDB (smaller database)
        time = '12h'      // Faster with RVDB
        label = 'process_high'
    }
    
    withName: 'MERGE_DIAMOND_REPORTS' {
        cpus = 2
        memory = '8 GB'
        time = '1h'
        label = 'process_low'
    }
    
    withName: 'CALCULATE_ABUNDANCE_MEGAHIT' {
        cpus = 8
        memory = '16 GB'
        time = '6h'
        label = 'process_medium'
    }
    
    withName: 'CALCULATE_ABUNDANCE_SPADES' {
        cpus = 8
        memory = '16 GB'
        time = '6h'
        label = 'process_medium'
    }
    
    withName: 'CALCULATE_ABUNDANCE_METAFLYE' {
        cpus = 16
        memory = '32 GB'
        time = '12h'
        label = 'process_medium'
    }
    
    withName: 'CALCULATE_ABUNDANCE_VIRALFLYE' {
        cpus = 16
        memory = '32 GB'
        time = '12h'
        label = 'process_medium'
    }
    
    // Long read process resource allocation
    withName: 'METAFLYE_ASSEMBLY' {
        cpus = 32
        memory = '128 GB'  // MetaFlye requires more memory
        time = '48h'       // Long-read assembly requires more time
        label = 'process_high'
    }
    
    withName: 'VIRALFLYE_REFINEMENT' {
        cpus = 16
        memory = '64 GB'
        time = '24h'
        label = 'process_medium'
    }
    
    // Long read process resource allocation
    withName: 'PRODIGAL_METAFLYE' {
        cpus = 4
        memory = '16 GB'
        time = '4h'
        label = 'process_medium'
    }
    
    withName: 'PRODIGAL_VIRALFLYE' {
        cpus = 4
        memory = '16 GB'
        time = '4h'
        label = 'process_medium'
    }
    
    withName: 'DIAMOND_CLASSIFICATION_METAFLYE' {
        cpus = 16
        memory = '64 GB'
        time = '12h'
        label = 'process_high'
    }
    
    withName: 'DIAMOND_CLASSIFICATION_VIRALFLYE' {
        cpus = 16
        memory = '64 GB'
        time = '12h'
        label = 'process_high'
    }
    
    withName: 'ADD_TAXONOMY_METAFLYE' {
        cpus = 2
        memory = '8 GB'
        time = '2h'
        label = 'process_low'
    }
    
    withName: 'ADD_TAXONOMY_VIRALFLYE' {
        cpus = 2
        memory = '8 GB'
        time = '2h'
        label = 'process_low'
    }
    
    withName: 'COMPARE_DUAL_TRACKS' {
        cpus = 2
        memory = '8 GB'
        time = '1h'
        label = 'process_low'
    }
}

params {
    // Output directories (automatically created)
    // - assembly_megahit/: MEGAHIT assembled contigs
    // - assembly_spades/: SPAdes assembled contigs
    // - prodigal_megahit/: Gene predictions from MEGAHIT
    // - prodigal_spades/: Gene predictions from SPAdes
    // - diamond_megahit/: Diamond results for MEGAHIT
    // - diamond_spades/: Diamond results for SPAdes
    // - merged_reports/: Comprehensive analysis with taxonomy
    // - assembly_metaflye/: MetaFlye assembled contigs (long reads)
    // - assembly_viralflye/: viralFlye refined contigs (long reads, optional)
    // - prodigal_long/: Gene predictions from long reads
    // - diamond_long/: Diamond results for long reads
    
    // Resource  limits
    max_cpus = 32
    max_memory = '512.GB'  // Adjusted to support 512GB memory requirement for SPAdes
    max_time = '72.h'
    
    // Read type parameter
    read_type = 'short'  // 'short' for short reads (paired-end), 'long' for long reads (Nanopore/PacBio)
    
    // fastp quality control parameters (for short reads only)
    skip_fastp = false
    fastp_qualified_quality = 20    // Minimum quality value
    fastp_unqualified_percent = 40  // Maximum percentage of low-quality bases allowed
    fastp_min_length = 50           // Minimum read length
    
    // MEGAHIT assembly parameters (for short reads only)
    megahit_memory = 0.8
    megahit_min_contig_len = 1000
    
    // SPAdes parameters (for short reads only, using metaSPAdes mode)
    spades_meta = true
    
    // MetaFlye parameters (for long reads only)
    metaflye_genome_size = null     // Genome size estimate, e.g., '5m' or '10m', null means let Flye estimate automatically
    skip_viralflye = false          // Must enable viralFlye for viral data analysis
    
    // viralFlye parameters (requires Pfam-A HMM database)
    pfam_hmm = '/scratch/sp96859/Meta-genome-data-analysis/Apptainer/databases/Pfam/Pfam-A.hmm'  // Pfam-A HMM database path
    viralflye_min_length = 5000       // Minimum viral sequence length
    viralflye_completeness = 0.5      // Completeness threshold
    
    // Diamond parameters
    diamond_evalue = 1e-5
    diamond_max_target_seqs = 1
    diamond_outfmt = '6 qseqid sseqid pident length mismatch gapopen qstart qend sstart send evalue bitscore staxids'
    
    // Taxonomy database parameters (NCBI taxonomy for lineage resolution)
    taxonomy_names = '/scratch/sp96859/Meta-genome-data-analysis/Apptainer/databases/RVDB/names.dmp'
    taxonomy_nodes = '/scratch/sp96859/Meta-genome-data-analysis/Apptainer/databases/RVDB/nodes.dmp'
    
    // Merge reports parameters (for short reads only)
    skip_merge_reports = false  // Whether to skip comprehensive report generation
    
    // Abundance calculation parameters (for short reads only)
    skip_abundance = false  // Whether to skip viral abundance calculation (RPM and RPKM)
}

// Apptainer/Singularity configuration (no longer needed; MEGAHIT and SPAdes now use system environment nextflow_env)
// apptainer {
//     enabled = true
//     autoMounts = true
//     cacheDir = '/scratch/sp96859/Meta-genome-data-analysis/Apptainer/singularity'
// }

// Conda configuration (for Diamond, Prodigal, and fastp)
conda {
    enabled = true
    cacheDir = '/scratch/sp96859/Meta-genome-data-analysis/conda_cache'
}

// Environment variables (no container binding needed; MEGAHIT and SPAdes use system environment nextflow_env)
// env {
//     SINGULARITY_BIND = "/scratch/sp96859/Meta-genome-data-analysis/Apptainer/databases:/databases,/tmp:/lscratch"
// }

// Input samplesheet format
// For short reads (paired-end Illumina):
//   sample,fastq_1,fastq_2
//   llnl_66ce4dde,/path/to/sample_R1.fastq.gz,/path/to/sample_R2.fastq.gz
//
// For long reads (Nanopore/PacBio):
//   sample,fastq_long
//   llnl_66d1047e,/path/to/sample.fastq.gz
