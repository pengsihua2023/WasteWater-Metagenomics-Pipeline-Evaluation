// Metagenome Viral Classification Workflow Configuration
// Version: 5.1.0
//
// This configuration file defines:
// 1. Metagenome assembly (MEGAHIT and SPAdes parallel assembly)
// 2. Viral sequence identification (VirSorter2 and DeepVirFinder)
// 3. Comprehensive comparison and merging of viral identification results
// 4. Assembler comparison to identify high-confidence consensus viral sequences
//
// Usage example:
// nextflow run metagenome_assembly_classification_workflow.nf -c metagenome_assembly_classification.config --input samplesheet.csv --outdir results --virsorter2_db /path/to/virsorter2/db --deepvirfinder_dir /path/to/DeepVirFinder

process {
    executor = 'slurm'
    queue = 'bahl_p'
    clusterOptions = '--ntasks=1'
    
    errorStrategy = 'retry'
    maxRetries = 2
    
    // CRITICAL: Clean PYTHONPATH before all processes to avoid conda environment conflicts
    beforeScript = 'unset PYTHONPATH 2>/dev/null || true'
    
    // Default resource allocation
    cpus = 8
    memory = '32 GB'
    time = '6h'
    
    // Process-specific resource allocation
    withName: 'FASTP' {
        cpus = 8
        memory = '16 GB'
        time = '4h'
        label = 'process_medium'
    }
    
    withName: 'MEGAHIT_ASSEMBLY' {
        cpus = 16
        memory = '64 GB'
        time = '12h'
        label = 'process_high'
    }
    
    withName: 'SPADES_ASSEMBLY' {
        cpus = 32
        memory = '512 GB'  // Use large memory to avoid issues
        time = '48h'       // Metagenome assembly requires longer time
        label = 'process_high'
    }
    
    // Long-read: metaFlye assembly and QC
    withName: 'LONGREAD_QC' {
        cpus = 4
        memory = '8 GB'
        time = '2h'
        label = 'process_medium'
    }
    
    withName: 'METAFLYE_ASSEMBLY' {
        cpus = 32
        memory = '128 GB'
        time = '48h'
        label = 'process_high'
    }
    
    withName: 'SELECT_VIRAL_TARGETS_METAFLYE' {
        cpus = 2
        memory = '4 GB'
        time = '1h'
        label = 'process_low'
    }
    
    withName: 'SUBSET_LONGREADS_FOR_VIRAL' {
        cpus = 16
        memory = '32 GB'
        time = '12h'
        label = 'process_medium'
    }
    
    withName: 'VIRSORTER2_MEGAHIT' {
        cpus = 16
        memory = '64 GB'
        time = '24h'
        label = 'process_high'
    }
    
    withName: 'VIRSORTER2_SPADES' {
        cpus = 16
        memory = '64 GB'
        time = '24h'
        label = 'process_high'
    }
    
    withName: 'VIRSORTER2_METAFLYE' {
        cpus = 16
        memory = '64 GB'
        time = '24h'
        label = 'process_high'
    }
    
    withName: 'DEEPVIRFINDER_MEGAHIT' {
        cpus = 8
        memory = '32 GB'
        time = '12h'
        label = 'process_high'
    }
    
    withName: 'DEEPVIRFINDER_SPADES' {
        cpus = 8
        memory = '32 GB'
        time = '12h'
        label = 'process_high'
    }
    
    withName: 'DEEPVIRFINDER_METAFLYE' {
        cpus = 8
        memory = '32 GB'
        time = '12h'
        label = 'process_high'
    }
    
    withName: 'MERGE_VIRAL_REPORTS_MEGAHIT' {
        cpus = 2
        memory = '8 GB'
        time = '1h'
        label = 'process_low'
    }
    
    withName: 'MERGE_VIRAL_REPORTS_SPADES' {
        cpus = 2
        memory = '8 GB'
        time = '1h'
        label = 'process_low'
    }
    
    withName: 'COMPARE_ASSEMBLERS' {
        cpus = 2
        memory = '8 GB'
        time = '1h'
        label = 'process_low'
    }
    
    withName: 'MERGE_VIRAL_REPORTS_METAFLYE' {
        cpus = 2
        memory = '8 GB'
        time = '1h'
        label = 'process_low'
    }
    
    withName: 'COMPARE_THREE_VIRAL_TOOLS' {
        cpus = 2
        memory = '8 GB'
        time = '1h'
        label = 'process_low'
    }
    
    withName: 'VIRALFLYE_IDENTIFY' {
        cpus = 32
        memory = '128 GB'
        time = '36h'
        label = 'process_high'
    }
    
    withName: 'CALCULATE_ABUNDANCE' {
        cpus = 16
        memory = '32 GB'
        time = '12h'
        label = 'process_medium'
    }
    
    withName: 'CALCULATE_ABUNDANCE_LONGREAD' {
        cpus = 16
        memory = '32 GB'
        time = '12h'
        label = 'process_medium'
    }
}

params {
    // Resource limits
    max_cpus = 32
    max_memory = '512.GB'  // Adjusted to support 512GB memory requirement for SPAdes
    max_time = '72.h'
    
    // Workflow control
    skip_virsorter2 = false    // Whether to skip VirSorter2 viral identification
    skip_deepvirfinder = false // Whether to skip DeepVirFinder viral identification
    skip_merge_reports = false // Whether to skip result merging
    
    // fastp quality control parameters
    skip_fastp = false
    save_clean_reads = true    // Whether to save filtered clean reads
    fastp_qualified_quality = 20    // Minimum quality value
    fastp_unqualified_percent = 40  // Maximum percentage of low-quality bases allowed
    fastp_min_length = 50           // Minimum read length
    
    // MEGAHIT assembly parameters
    megahit_memory = 0.8
    megahit_min_contig_len = 1000
    
    // SPAdes parameters (using metaSPAdes mode)
    spades_meta = true
    
    // Long-read parameters
    longread = false                  // Enable long-read branch (PacBio/Nanopore)
    longread_platform = 'nano'        // Platform: 'nano' or 'pacbio'
    skip_longread_qc = true           // Skip long-read QC
    enable_viralflye = false          // Enable viralFlye refinement
    viralflye_min_score = 0.5         // Minimum VS2 score for target selection
    viralflye_min_length = 500        // ⭐ Optimized: decreased from 1000 to 500 (identify more viruses)
    viralflye_completeness = 0.3      // ⭐⭐ Completeness threshold (default 0.5, decreased to 0.3 to identify more viruses)
    viralflye_env = '/home/sp96859/.conda/envs/viralFlye_env'  // viralFlye conda environment path
    pfam_db = '/scratch/sp96859/Meta-genome-data-analysis/Apptainer/databases/Pfam/Pfam-A.hmm'  // Pfam database for viralFlye
    
    // VirSorter2 parameters
    virsorter2_min_length = 1000      // Minimum contig length
    virsorter2_min_score = 0.5        // Minimum viral score
    
    // DeepVirFinder parameters  
    deepvirfinder_min_length = 1000   // Minimum contig length
    deepvirfinder_pvalue = 0.05       // ⭐ P-value threshold (0.05=more viruses, 0.01=more stringent)
}

// Apptainer/Singularity configuration (for MEGAHIT and SPAdes only)
apptainer {
    enabled = true
    autoMounts = true  // Need to automatically mount working directory
    cacheDir = '/scratch/sp96859/Meta-genome-data-analysis/Apptainer/singularity'
    // Explicitly mount required paths to avoid errors with non-existent paths like /lscratch
    runOptions = '--bind /scratch:/scratch --bind /home:/home --containall'
    pullTimeout = '60m'
}

// Conda configuration (for fastp and VirSorter2)
// Note: VirSorter2 uses pre-installed nextflow_env environment
// Note: DeepVirFinder uses pre-installed dvf environment (activated manually in script)
conda {
    enabled = true
    cacheDir = '/scratch/sp96859/Meta-genome-data-analysis/conda_cache'
    useMamba = false  // Use conda instead of mamba
}

// Environment variables
env {
    // Bind host database directory to /databases in container
    SINGULARITY_BIND = "/scratch/sp96859/Meta-genome-data-analysis/Apptainer/databases:/databases"
    
    // Ensure conda environment PATH priority
    // Nextflow automatically handles conda environment activation, but we ensure user environment bin directory is in PATH
    NXF_CONDA_CACHEDIR = '/scratch/sp96859/Meta-genome-data-analysis/conda_cache'
}

// Input samplesheet format
// Short-read samplesheet (Illumina): sample,fastq_1,fastq_2
// Example:
// sample,fastq_1,fastq_2
// s1,/path/to/sample_R1.fastq.gz,/path/to/sample_R2.fastq.gz

// Long-read samplesheet (PacBio/Nanopore): sample,fastq_long
// Example:
// sample,fastq_long
// s1,/path/to/sample_nanopore.fastq.gz

