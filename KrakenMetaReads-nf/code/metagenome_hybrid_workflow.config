// Hybrid Metagenome Assembly and Kraken2 Workflow Configuration
//
// Supports both short-read and long-read metagenome analysis
//
// Usage:
// nextflow run metagenome_hybrid_workflow.nf -c metagenome_hybrid_workflow.config

process {
    executor = 'slurm'
    queue = 'bahl_p'
    clusterOptions = '--ntasks=1'
    
    errorStrategy = 'retry'
    maxRetries = 2
    
    // Default resource allocation
    cpus = 8
    memory = '32 GB'
    time = '6h'
    
    // ========================================
    // SHORT-READ PROCESSES
    // ========================================
    
    withName: 'FASTP' {
        cpus = 8
        memory = '16 GB'
        time = '4h'
        label = 'process_medium'
    }
    
    withName: 'MEGAHIT_ASSEMBLY' {
        cpus = 16
        memory = '64 GB'
        time = '12h'
        label = 'process_high'
    }
    
    withName: 'SPADES_ASSEMBLY' {
        cpus = 32
        memory = '512 GB'
        time = '48h'
        label = 'process_high'
    }
    
    withName: 'BOWTIE2_BUILD_MEGAHIT' {
        cpus = 8
        memory = '16 GB'
        time = '2h'
        label = 'process_medium'
    }
    
    withName: 'BOWTIE2_BUILD_SPADES' {
        cpus = 8
        memory = '16 GB'
        time = '2h'
        label = 'process_medium'
    }
    
    withName: 'BOWTIE2_ALIGN_MEGAHIT' {
        cpus = 16
        memory = '32 GB'
        time = '8h'
        label = 'process_high'
    }
    
    withName: 'BOWTIE2_ALIGN_SPADES' {
        cpus = 16
        memory = '32 GB'
        time = '8h'
        label = 'process_high'
    }
    
    withName: 'CALCULATE_ABUNDANCE_MEGAHIT' {
        cpus = 2
        memory = '8 GB'
        time = '1h'
        label = 'process_low'
    }
    
    withName: 'CALCULATE_ABUNDANCE_SPADES' {
        cpus = 2
        memory = '8 GB'
        time = '1h'
        label = 'process_low'
    }
    
    withName: 'KRAKEN2_CLASSIFICATION_MEGAHIT' {
        cpus = 16
        memory = '48 GB'
        time = '8h'
        label = 'process_medium'
    }
    
    withName: 'KRAKEN2_CLASSIFICATION_SPADES' {
        cpus = 16
        memory = '48 GB'
        time = '8h'
        label = 'process_medium'
    }
    
    withName: 'MERGE_KRAKEN2_REPORTS_SHORT' {
        cpus = 2
        memory = '8 GB'
        time = '1h'
        label = 'process_low'
    }
    
    // ========================================
    // LONG-READ PROCESSES
    // ========================================
    
    withName: 'FLYE_ASSEMBLY' {
        cpus = 32
        memory = '128 GB'
        time = '72h'
        label = 'process_high'
    }
    
    withName: 'VIRALFLYE_IDENTIFY' {
        cpus = 16
        memory = '64 GB'
        time = '12h'
        label = 'process_high'
    }
    
    withName: 'MINIMAP2_ALIGN_FLYE' {
        cpus = 16
        memory = '32 GB'
        time = '8h'
        label = 'process_high'
    }
    
    withName: 'MINIMAP2_ALIGN_VIRALFLYE_LINEAR' {
        cpus = 8
        memory = '16 GB'
        time = '4h'
        label = 'process_medium'
    }
    
    withName: 'MINIMAP2_ALIGN_VIRALFLYE_CIRCULAR' {
        cpus = 8
        memory = '16 GB'
        time = '4h'
        label = 'process_medium'
    }
    
    withName: 'CALCULATE_ABUNDANCE_FLYE' {
        cpus = 2
        memory = '8 GB'
        time = '1h'
        label = 'process_low'
    }
    
    withName: 'CALCULATE_ABUNDANCE_VIRALFLYE_LINEAR' {
        cpus = 2
        memory = '8 GB'
        time = '1h'
        label = 'process_low'
    }
    
    withName: 'CALCULATE_ABUNDANCE_VIRALFLYE_CIRCULAR' {
        cpus = 2
        memory = '8 GB'
        time = '1h'
        label = 'process_low'
    }
    
    withName: 'KRAKEN2_CLASSIFICATION_FLYE' {
        cpus = 16
        memory = '48 GB'
        time = '8h'
        label = 'process_medium'
    }
    
    withName: 'KRAKEN2_CLASSIFICATION_VIRALFLYE_LINEAR' {
        cpus = 8
        memory = '24 GB'
        time = '4h'
        label = 'process_medium'
    }
    
    withName: 'KRAKEN2_CLASSIFICATION_VIRALFLYE_CIRCULAR' {
        cpus = 8
        memory = '24 GB'
        time = '4h'
        label = 'process_medium'
    }
}

params {
    // Resource limits
    max_cpus = 32
    max_memory = '512.GB'
    max_time = '72.h'
    
    // Short-read parameters
    skip_fastp = false
    fastp_qualified_quality = 20
    fastp_unqualified_percent = 40
    fastp_min_length = 50
    
    megahit_memory = 0.8
    megahit_min_contig_len = 1000
    spades_meta = true
    
    // Long-read parameters
    flye_genome_size = '5m'
    flye_min_overlap = 3000
    long_read_type = 'nanopore'  // Options: 'nanopore', 'pacbio', 'pacbio-hifi'
    run_viralflye = true  // Run viralFlye to identify viral contigs from metaFlye
    viralflye_hmm = '/scratch/sp96859/Meta-genome-data-analysis/Apptainer/databases/Pfam/Pfam-A.hmm'
    viralflye_min_length = 2000  // Minimum viral contig length (2kb to capture small DNA viruses like Circoviridae)
    viralflye_completeness = 0.5  // Completeness cutoff (0.5 for complete viral genomes)
    viralflye_threads = 10  // Threads for viralFlye
    
    // Kraken2 parameters
    kraken2_confidence = 0.05
    kraken2_min_base_quality = 0
    kraken2_min_hit_groups = 1
    
    // Report parameters
    skip_merge_reports = false
}

// Apptainer/Singularity configuration
apptainer {
    enabled = true
    autoMounts = true
    cacheDir = '/scratch/sp96859/Meta-genome-data-analysis/Apptainer/singularity'
    runOptions = '--no-mount /lscratch'  // Disable /lscratch mount (not available on this cluster)
}

// Conda configuration
conda {
    enabled = true
    cacheDir = '/scratch/sp96859/Meta-genome-data-analysis/conda_cache'
}

// Environment variables
env {
    SINGULARITY_BIND = "/scratch/sp96859/Meta-genome-data-analysis/Apptainer/databases:/databases"
}
